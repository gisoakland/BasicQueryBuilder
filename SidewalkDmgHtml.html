<!DOCTYPE html>
<html>
  <head>
    <title>Sidewalk Damage</title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
    <link rel="shortcut icon" href="http://cartodb.com/assets/favicon.ico" />
    
    <!-- Map takes up full browser window -->
    <style>
      html, body, #map {
        height: 90%;
        padding: 0;
        margin: 0;
      }
	 <!-- .controls {
        margin-top: 16px;
        border: 1px solid transparent;
        border-radius: 2px 0 0 2px;
        box-sizing: border-box;
        -moz-box-sizing: border-box;
        height: 32px;
        outline: none;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
      }-->
    </style>

    <link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v3/3.14/themes/css/cartodb.css" />
  </head>
  <body>
	<input id="pac-input" class="controls" type="text" placeholder="Search Box">
    <div id="map"></div>
	<div>
		<input type="text" id="textBox">
		<input type="button" value="Find" id="Find">
		<input type="button" value="Clear" id="Clear">
	</div>
	<script src="https://maps.googleapis.com/maps/api/js?v=3.exp&signed_in=false&libraries=places"></script>
	<!--<script src="https://maps.googleapis.com/maps/api/js?sensor=false"></script>-->
    <!-- include cartodb.js library -->
    <script src="http://libs.cartocdn.com/cartodb.js/v3/3.14/cartodb.js"></script>
    
    <!-- Drop your code between the script tags below! -->
    <script>
	
	
	window.onload = function() {
		//tables you're using
		var tableName = "gisadmin_sidewalkdamageapn_citywide";
		//layers to add to map
		var vizjson = "https://oakland.cartodb.com/u/oakland-admin/api/v2/viz/761dd91e-24c3-11e5-80ab-42010a149c0c/viz.json";
		//login data
		var layerSource = {
			user_name: 'oakland-admin',
			type: 'cartodb',
			sublayers: [{
				sql: "SELECT * FROM " + tableName,
				cartocss: $("simple").html()
			}]
		}
		// Initialize map center and zoom level
		var options = {
					center: [37.8,-122.21], // Oakland
					zoom: 12
		}
		
		// Instantiate map on specified DOM element
		var map_object = new L.Map(map, options);
		
		// Add a basemap to the map object just created
		L.tileLayer('http://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', {
			attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, &copy; <a href="http://cartodb.com/attributions">CartoDB</a>'
			}).addTo(map_object);
        
		var sublayers = [];
		cartodb.createLayer(map_object, vizjson)
			.addTo(map_object)
			.done(function(layer){
				var sublayer = layer.getSubLayer(0);
				sublayers.push(sublayer);
				//call functions to trigger the eventhandlers
				createClickEvent($('#Find'), tableName + " WHERE apn = ", 0);
				createClearEvent($('#Clear'), tableName, 0);
				
			})
			.error(function(err){
				console.log("error: " + err);
			});
		initSearchBox();
		
		function initSearchBox(){
			var markers = [];
			var input = /** @type {HTMLInputElement} */(document.getElementById('pac-input'));
			
			var searchBox = new google.maps.places.SearchBox( /** @type {HTMLInputElement} */(input));
			
			google.maps.event.addListener(searchBox, 'places_changed', function(){
				var places = searchBox.getPlaces();
				if (places.length == 0){
					return;
				}
				for (var i = 0, marker; marker = markers[i]; i++) {
					marker.setMap(null);
				}
				
				markers = [];
				var lat;
				var lng;
				for (var i = 0, place; place = places[i]; i++){
					var image = {
						url: place.icon,
						size: new google.maps.Size(71,71),
						origin: new google.maps.Point(0,0),
						anchor: new google.maps.Point(17,34),
						scaledSize: new google.maps.Size(25,25)
					};
					var marker = new google.maps.Marker({
						icon: image,
						title: place.name,
						position: place.geometry.location
					});
					markers.push(marker);
					lat = place.geometry.location.lat();
					lng = place.geometry.location.lng();
				}
				map_object.panTo({lat:lat, lng:lng});
				map_object.setZoom(17);
			});
			
			google.maps.event.addListener(map_object, 'bounds_changed', function(){
				var bounds = map_object.getBounds();
				searchBox.setBounds(bounds);
			});
		}
		
		//query for createClickEvent requires the tablename and the comparison statement with the field to query
		//separating the fieldquery into 2 separate functions, event handler and a query builder
		function createClickEvent($button, query, layerNum){
			$button.click(function(){
				newQuery = "SELECT * FROM " + query + "'" + document.getElementById('textBox').value + "'";
				createQuery(newQuery, layerNum);
			})
		}
		
		function createQuery(query, layerNum){
			var sql = new cartodb.SQL({user: layerSource.user_name});
			sublayers[layerNum].setSQL(query);
			sql.getBounds(query).done(function(bounds){
				map_object.fitBounds(bounds, {maxZoom:17});
				console.log(bounds);
			})
			return;
		}
		
		function createClearEvent($button, query, layerNum){
			$button.click(function(){
				newQuery = "SELECT * FROM " + query;
				createQuery(newQuery, layerNum);
			})
		}
		
		
	}
	
	
		// http://academy.cartodb.com/courses/03-cartodbjs-ground-up/lesson-1.html
    </script>

  </body>
</html>