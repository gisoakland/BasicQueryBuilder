<!DOCTYPE html>
<html>
  <head>
    <title>Sidewalk Damage</title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
    <link rel="shortcut icon" href="http://cartodb.com/assets/favicon.ico" />
    
    <!-- Map takes up full browser window -->
    <style>
      html, body, #map {
        height: 90%;
        padding: 0;
        margin: 0;
      }
    </style>

    <link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v3/3.14/themes/css/cartodb.css" />
  </head>
  <body>
    <div id="map"></div>
	<div>
		<input type="text" id="textBox">
		<input type="button" value="Find" id="Find">
		<input type="button" value="Clear" id="Clear">
	</div>
	<script src="https://maps.googleapis.com/maps/api/js?sensor=false"></script>
    <!-- include cartodb.js library -->
    <script src="http://libs.cartocdn.com/cartodb.js/v3/3.14/cartodb.js"></script>
    
    <!-- Drop your code between the script tags below! -->
    <script>
	
	
	window.onload = function() {
		//tables you're using
		var tableName = "gisadmin_sidewalkdamageapn_citywide";
		//layers to add to map
		var vizjson = "https://oakland.cartodb.com/u/oakland-admin/api/v2/viz/761dd91e-24c3-11e5-80ab-42010a149c0c/viz.json";
		//login data
		var layerSource = {
			user_name: 'oakland-admin',
			type: 'cartodb',
			sublayers: [{
				sql: "SELECT * FROM " + tableName,
				cartocss: $("simple").html()
			}]
		}
		// Initialize map center and zoom level
		var options = {
					center: [37.8,-122.21], // Oakland
					zoom: 12
		}
		
		// Instantiate map on specified DOM element
		var map_object = new L.Map(map, options);
    
		// Add a basemap to the map object just created
		L.tileLayer('http://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', {
			attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, &copy; <a href="http://cartodb.com/attributions">CartoDB</a>'
			}).addTo(map_object);
        
		var sublayers = [];
		cartodb.createLayer(map_object, vizjson)
			.addTo(map_object)
			.done(function(layer){
				var sublayer = layer.getSubLayer(0);
				sublayers.push(sublayer);
				//call functions to trigger the eventhandlers
				createClickEvent($('#Find'), tableName + " WHERE apn = ", 0, 17);
				createClearEvent($('#Clear'), tableName, 0);
				
			})
			.error(function(err){
				console.log("error: " + err);
			});
		
		//query for createClickEvent requires the tablename and the comparison statement with the field to query
		//separating the fieldquery into 2 separate functions, event handler and a query builder
		function createClickEvent($button, query, layerNum, zoomLevel){
			$button.click(function(){
				newQuery = "SELECT * FROM " + query + "'" + document.getElementById('textBox').value + "'";
				createQuery(newQuery, layerNum);
				map_object.setZoom(zoomLevel);
			})
		}
		
		function createQuery(query, layerNum){
			var sql = new cartodb.SQL({user: layerSource.user_name});
			sublayers[layerNum].setSQL(query);
			sql.getBounds(query).done(function(bounds){
				map_object.fitBounds(bounds);
			})
			return;
		}
		
		function createClearEvent($button, query, layerNum){
			$button.click(function(){
				newQuery = "SELECT * FROM " + query;
				createQuery(newQuery, layerNum);
				map_object.setZoom(12);
			})
		}
		
		
		//change
		
	}

		// http://academy.cartodb.com/courses/03-cartodbjs-ground-up/lesson-1.html
    </script>

  </body>
</html>


